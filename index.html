<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cara Mia Addio</title>
    <link rel="stylesheet" href="https://unpkg.com/simpledotcss/simple.min.css">
    <link rel="stylesheet" href="https://unpkg.com/animate.css@4.1.1/animate.min.css">
    <script src="https://unpkg.com/lrc-file-parser@2.2.8/dist/lrc-file-parser.min.js"></script>
    <!--https://github.com/lyswhut/lrc-file-parser-->

    <!--Preload audio file.-->
    <audio id="audio" preload="auto" src="song.ogg"></audio>

    <script>
        const animateCSS = (element, animation, prefix = 'animate__') =>
            // We create a Promise and return it
            new Promise((resolve, reject) => {
                const animationName = `${prefix}${animation}`;
                const node = document.querySelector(element);

                node.classList.add(`${prefix}animated`, animationName);

                // When the animation ends, we clean the classes and resolve the Promise
                function handleAnimationEnd(event) {
                    event.stopPropagation();
                    node.classList.remove(`${prefix}animated`, animationName);
                    resolve('Animation ended');
                }

                node.addEventListener('animationend', handleAnimationEnd, { once: true });
            });
    </script>
    <!--Load lrc file with xhr.-->
    <script>
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'lyrics.lrc');
        xhr.onload = function () {
            /** Parse the lrc file content. */
            window.lrc = new Lyric({
                onPlay: function (line, text) { // Listening play event
                    console.log(line, text) // line is line number of current play
                    // text is lyric text of current play line
                    var lyrics = document.getElementById('lyrics');
                    // First, get previous line id and set fadeOut
                    var prevLineNum = line - 1;
                    var prevLine = document.getElementById("lyric" + prevLineNum);
                    console.log("lyric" + prevLineNum);
                    if (prevLine) {
                        prevLine.classList.remove('animate__fadeIn');
                        prevLine.classList.add('animate__animated', 'animate__fadeOut');
                    }
                    // Second, append new line and set fadeIn
                    var newLine = document.createElement('p');
                    newLine.id = "lyric" + line;
                    newLine.innerHTML = text;
                    newLine.classList.add('animate__animated', 'animate__fadeIn');
                    lyrics.appendChild(newLine);
                    // Third, make sure only 3 lines are displayed
                    var lines = lyrics.getElementsByTagName('p');
                    if (lines.length > 3) {
                        lyrics.removeChild(lines[0]);
                    }
                },
                onSetLyric: function (lines) { // listening lyrics seting event
                    console.log(lines) // lines is array of all lyric text
                },
                offset: 0, // offset time(ms), default is 150 ms
                isRemoveBlankLine: false // is remove blank line, default is true
            })
            lrc.setLyric(xhr.responseText) // set lrc file content
        };
        // if failed, show error
        xhr.onerror = function () {
            window.lrc = "[00:00.00]Failed to load lyrics.";
        };
        xhr.send();
    </script>
</head>

<body>
    <div id="lyrics">
        <p id="lyric-1">Press to play.</p>
    </div>
    <style>
        /** Put the lyric to the center of the page. */
        #lyrics {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }

        /** Make the lyric font size bigger. */
        #lyrics {
            font-size: 2em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /** Black body background. */
        body {
            background-color: black;
            /** unselectable text */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
    <script>
        /** Get the audio element. */
        var audio = document.getElementById('audio');

        /** Get the lyrics element. */
        var lyrics = document.getElementById('lyrics');

        function playSong() {
            audio.play();
            window.lrc.play(0);
        }

        /** On click, play the audio. */
        lyrics.onclick = function () {
            playSong();
            // Disable the click event.
            lyrics.onclick = null;
        };

        /** If ends, restore click event. */
        audio.onended = function () {
            lyrics.onclick = function () {
                // clear lyrics
                lyrics.innerHTML = "";
                // put back the first line
                var newLine = document.createElement('p');
                newLine.id = "lyric-1";
                newLine.innerHTML = "Press to play.";
                lyrics.appendChild(newLine);
                // play song
                playSong();
                // Disable the click event.
                lyrics.onclick = null;
            };
        };
    </script>
</body>

</html>